#!/usr/bin/env bash

set -u -o pipefail

CMD="$(basename "$0")"
CMD_DIR="$(dirname "$0")"
function usage {
    (echo "Usage: $CMD [-hnv] stats-file"
     echo "-f        Force a full recreation of the stats-file."
     echo "-h        Print this help message."
     echo "-n        Dry run. Don't execute commands."
     echo "-v        Verbose. Print extra information if appropriate."
     echo "Update list of Fortran file stats based on recent file changes.") 1>&2
}

. "$CMD_DIR/vecho"

FFLAG=
DRY_RUN=
VFLAG=0
while getopts fhnv\? OPTCHAR; do
    case $OPTCHAR in
        f)  FFLAG=1;;
        h)  usage; exit 0;;
        n)  DRY_RUN=1;;
        v)  VFLAG=$((VFLAG+1));;
    esac
done

shift $(($OPTIND - 1))

case $# in
    1)  STATS_CSV="$1";;
    *)  usage; exit 1;;
esac

TMP="$(mktemp "$STATS_CSV.tmp.XXXXXX")"
trap 'rm -f "$TMP"; exit 1' HUP INT QUIT TERM

if [[ -n "$FFLAG" ]] || [[ ! -e "$STATS_CSV" ]]; then
    # Rebuild from scratch.
    echo "Rebuild '$STATS_CSV' from scratch..."

    # Assume all-fortran-files.txt is sorted to avoid sorting.
    ($CMD_DIR/fpp-stats -H \
         && builtin cd fortran-examples \
         && cat all-fortran-files.txt | xargs "../$CMD_DIR/fpp-stats") >"$TMP"
else
    # Not rebuilding from scratch.

    #   1. Identify new or updated files
    #   2. Identify missing files
    #   2. Concatenate
    #      a. Old stats with updated or deleted entries removed.
    #      b. Stats for new or updated files.
    #   3. Sort by file name and place result in temp statistics.
    #   4. If -v, show the diff.
    #   5. Replace $STATS_CSV with the updated temp statistics.

    NEW_OR_UPDATED="$(for F in `cat fortran-examples/all-fortran-files.txt`; do
                          if [[ fortran-examples/"$F" -nt "$STATS_CSV" ]]; then
                               echo "$F"
                           fi;
                      done)"
    MISSING="$(for F in `cat fortran-examples/all-fortran-files.txt`; do
                   if [[ ! -e fortran-examples/"$F" ]]; then
                       echo "$F"
                   fi;
              done)"
    if [[ "$(echo "$NEW_OR_UPDATED" | wc -l)" -gt 100 ]]; then
        echo "NEW_OR_UPDATED is over 100 files?"
        exit 0
    fi
    vecho 2 "NEW_OR_UPDATED='$NEW_OR_UPDATED'"
    vecho 2 "MISSING='$MISSING'"

    if [[ "$NEW_OR_UPDATED" = "" ]]; then
        vecho 1 "$STATS_CSV is up to date."

        rm "$TMP"
        exit 0
    fi

    # Note that the STATS_CSV file does not quote the file name.
    # Technically, looking for quotes in the first field is unnecessary.
    # 'bin/fpp-stats' does not quote the file name.
    TO_REMOVE="-e 1d $(echo "$NEW_OR_UPDATED
$MISSING" \
                       | sed -n -e 's;/;\\/;g' -e 's;..*;-e /^\"*&\"*,/d;p')"
    vecho 2 "TO_REMOVE='$TO_REMOVE'"
    ("$CMD_DIR/fpp-stats" -H;
     (sed $TO_REMOVE <"$STATS_CSV";
      builtin cd fortran-examples \
          && echo "$NEW_OR_UPDATED" | xargs "../$CMD_DIR/fpp-stats") \
        | sort -t ',' -k 1) >"$TMP"
fi

# "$TMP" has the new version of the stats file, whether created anew
# or updated with only files that were added, deleted, or changed.
if [[ "$VFLAG" -ge 2 ]]; then
    echo "Diff: $STATS_CSV $TMP"
    diff "$STATS_CSV" "$TMP"
fi

if [[ -n "$DRY_RUN" ]]; then
    rm "$TMP"
else
    mv "$TMP" "$STATS_CSV"
fi

vecho 1 "$STATS_CSV updated."

exit 0
